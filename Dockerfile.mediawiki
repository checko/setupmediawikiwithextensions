FROM mediawiki:1.41

# Install required system packages for PdfHandler and tooling
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        git curl unzip \
        mariadb-client \
        imagemagick ghostscript poppler-utils \
        ffmpeg \
        ca-certificates \
        less vim-tiny \
    && rm -rf /var/lib/apt/lists/*

# Install Composer (for later use with Semantic MediaWiki at runtime)
RUN curl -fsSL https://getcomposer.org/installer -o /tmp/composer-setup.php \
    && php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer \
    && rm -f /tmp/composer-setup.php

# Allow running composer as root inside container without warnings
ENV COMPOSER_ALLOW_SUPERUSER=1

WORKDIR /var/www/html

# Fetch MsUpload (others are bundled with the MediaWiki image tarball)
RUN set -eux; \
    EXT_DIR=/var/www/html/extensions; \
    mkdir -p "$EXT_DIR"; \
    if [ ! -d "$EXT_DIR/MsUpload" ]; then \
      git clone --depth 1 -b REL1_41 https://github.com/wikimedia/mediawiki-extensions-MsUpload "$EXT_DIR/MsUpload"; \
    fi; \
    if [ ! -d "$EXT_DIR/TimedMediaHandler" ]; then \
      git clone --depth 1 -b REL1_41 https://github.com/wikimedia/mediawiki-extensions-TimedMediaHandler "$EXT_DIR/TimedMediaHandler"; \
    fi;

# Note: Semantic MediaWiki will be installed at runtime via composer inside the container

# Init/entry script to auto-install MW and enable extensions
COPY scripts/init-mediawiki.sh /usr/local/bin/init-mediawiki.sh
RUN chmod +x /usr/local/bin/init-mediawiki.sh

# Start Apache after init
CMD ["/usr/local/bin/init-mediawiki.sh"]
