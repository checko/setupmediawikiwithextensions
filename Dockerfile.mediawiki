FROM mediawiki:1.41

# Install required system packages for PdfHandler and tooling
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        git curl unzip \
        python3 python3-pygments \
        mariadb-client \
        imagemagick ghostscript poppler-utils \
        librsvg2-bin \
        fonts-noto-cjk fonts-noto-color-emoji fonts-arphic-uming fonts-arphic-ukai \
        ffmpeg \
        ca-certificates \
        less vim-tiny \
    && rm -rf /var/lib/apt/lists/*

# Install Composer (for later use with Semantic MediaWiki at runtime)
RUN curl -fsSL https://getcomposer.org/installer -o /tmp/composer-setup.php \
    && php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer \
    && rm -f /tmp/composer-setup.php

# Allow running composer as root inside container without warnings
ENV COMPOSER_ALLOW_SUPERUSER=1

WORKDIR /var/www/html

# Fetch MsUpload, TimedMediaHandler, SyntaxHighlight, WikiMarkdown, Mermaid (others are bundled with the MediaWiki image tarball)
RUN set -eux; \
    EXT_DIR=/var/www/html/extensions; \
    mkdir -p "$EXT_DIR"; \
    if [ ! -d "$EXT_DIR/MsUpload" ]; then \
      git clone --depth 1 -b REL1_41 https://github.com/wikimedia/mediawiki-extensions-MsUpload "$EXT_DIR/MsUpload"; \
    fi; \
    if [ ! -d "$EXT_DIR/TimedMediaHandler" ]; then \
      git clone --depth 1 -b REL1_41 https://github.com/wikimedia/mediawiki-extensions-TimedMediaHandler "$EXT_DIR/TimedMediaHandler"; \
    fi; \
    if [ ! -d "$EXT_DIR/SyntaxHighlight_GeSHi" ]; then \
      git clone --depth 1 -b REL1_41 https://github.com/wikimedia/mediawiki-extensions-SyntaxHighlight_GeSHi "$EXT_DIR/SyntaxHighlight_GeSHi"; \
    fi; \
    if [ ! -d "$EXT_DIR/WikiMarkdown" ]; then \
      git clone --depth 1 https://github.com/kuenzign/WikiMarkdown "$EXT_DIR/WikiMarkdown"; \
    fi; \
    if [ ! -d "$EXT_DIR/Mermaid" ]; then \
      git clone --depth 1 https://github.com/SemanticMediaWiki/Mermaid "$EXT_DIR/Mermaid"; \
    fi;

# Patch Mermaid extension to avoid bundling the library in RL; load via CDN at runtime
COPY patches/ext.mermaid.init.js /tmp/ext.mermaid.init.js
RUN set -eux; \
    cd /var/www/html/extensions/Mermaid; \
    python3 - <<'PY'
import json
p='extension.json'
data=json.load(open(p))
data['ResourceModules']['ext.mermaid']['packageFiles']=['resources/ext.mermaid.js']
json.dump(data, open(p,'w'), indent=2)
PY
RUN set -eux; \
    cd /var/www/html/extensions/Mermaid; \
    cp -f /tmp/ext.mermaid.init.js resources/ext.mermaid.js
RUN set -eux; \
    cd /var/www/html/extensions/Mermaid/resources; \
    curl -fsSL -o mermaid.min.js 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js'

# Install WikiMarkdown PHP dependencies
RUN set -eux; \
    cd /var/www/html/extensions/WikiMarkdown; \
    composer install --no-dev --no-interaction --no-progress --no-scripts --ignore-platform-reqs \
      || composer update --no-dev --no-interaction --no-progress --no-scripts --ignore-platform-reqs

# Install Semantic MediaWiki at build time to avoid runtime permission issues
RUN set -eux; \
    cd /var/www/html; \
    composer require --no-dev --no-interaction --no-progress "mediawiki/semantic-media-wiki:~4.1"

# Note: Semantic MediaWiki will be installed at runtime via composer inside the container

# Install getID3 library (vendor) for TimedMediaHandler metadata support
RUN set -eux; \
    GETID3_VER=v1.9.23; \
    curl -fsSL -o /tmp/getid3.zip "https://github.com/JamesHeinrich/getID3/archive/refs/tags/${GETID3_VER}.zip"; \
    mkdir -p /var/www/html/vendor/getid3; \
    unzip -q /tmp/getid3.zip -d /tmp; \
    # Normalize install path to /var/www/html/vendor/getid3/getid3
    mv /tmp/getID3-1.9.23/getid3 /var/www/html/vendor/getid3/getid3; \
    rm -f /tmp/getid3.zip

# Init/entry script to auto-install MW and enable extensions
COPY scripts/init-mediawiki.sh /usr/local/bin/init-mediawiki.sh
RUN chmod +x /usr/local/bin/init-mediawiki.sh

# Start Apache after init
CMD ["/usr/local/bin/init-mediawiki.sh"]
